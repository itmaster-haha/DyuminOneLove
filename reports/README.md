**Автор:** Roman Kiselev  
**Проект:** Объединение пассажирских данных из разных источников авиакомпаний SkyTeam / Sirena / BoardingPassDotAero / PointzAggregator и т. д.

---

##  Цель проекта
Создать **унифицированную таблицу рейсов и пассажиров** из множества разнородных источников:
- CSV с посадочными данными (`BoardingData.csv`);
- Excel-экспорт из Sirena (`Sirena-export-fixed.xlsx`);
- Папка Excel-файлов от BoardingPassDotAero;
- XML-дамп из PointzAggregator (`AirlinesData.xml`);
- JSON-профили FrequentFlyerForum;
- YAML-расписания SkyTeam;
- PDF-расписание Skyteam (`Skyteam_Timetable.pdf`).

---

##  Архитектура проекта

```
src/
 ├── sirena_reader.py           # Безопасное чтение Excel Sirena
 ├── excel_reader.py            # Параллельная обработка папки Excel-файлов
 ├── xml_reader.py              # Парсер XML PointzAggregator
 ├── json_reader.py             # Парсер Forum Profiles JSON
 ├── read_yaml_file.py          # Парсер YAML рейсов SkyTeam
 ├── parse_pdf_tables.py        # Полный парсер PDF расписания Skyteam (pypdf / PyPDF2)
 ├── normalize_flight_table.py  # Нормализация расписания в единую таблицу рейсов
 ├── name_utils.py              # Транслитерация и унификация имён
 ├── merge_csv.py               # Основной конвейер (построение и объединение данных)
 └── boarding_reader.py         #  Чтение и нормализация Boarding CSV
```

---

##  Логика обработки
Предварительная стандартизация данных

Перед запуском конвейера была выполнена предварительная стандартизация колонок во всех исходных файлах:
названия столбцов приведены к единому стилю (FirstName, DepartDate, FlightNumber, ArrivalCity и т. д.);
удалены пробелы, дублирующиеся или лишние символы ( , _x, _y и т. п.);
во всех CSV и Excel-файлах использованы одинаковые разделители (; и UTF-8 кодировка).
Эта подготовка позволила избежать конфликтов при объединении таблиц из разных источников
и гарантировала корректное слияние данных на всех этапах обработки




### **Этап 0. Подготовка расписания**

Файл `Skyteam_Timetable.pdf` содержит около **27 000 страниц** с расписанием рейсов.  
Из-за большого размера документ был обработан **автоматически с помощью скрипта `parse_pdf_tables.py`**,  
который постранично извлекает таблицы и объединяет их в единый файл `trial_flights.csv`.  

Обработка выполнялась пакетами по 100 страниц за процесс, что позволило использовать параллелизм и  
значительно ускорить парсинг без потери данных.  

Таким образом, `parse_pdf_tables.py` выполняет **полный парсинг PDF**,  
а результат (`trial_flights.csv`) используется далее в основном конвейере.

---

### **Дополнение: исправление Sirena данных**

Исходный экспорт Sirena (`Sirena-export-fixed.tab`) содержал ошибки в структуре —  
границы столбцов были нарушены, некоторые данные сдвинуты.  

Файл был **открыт и вручную выровнен в Microsoft Excel**,  
после чего сохранён как **`Sirena-export-fixed.xlsx`**.  

Используемый в проекте скрипт:
```
src/sirena_reader.py
```
работает именно с этой исправленной `.xlsx`-версией,  
обеспечивая корректное чтение колонок и стабильное извлечение данных.

---

### **Этап 1. Объединение пассажиров**
`merge_csv.build_passenger_block()`  
Собирает данные из всех источников пассажиров:
- CSV (boarding),
- Excel (Sirena),
- каталога Excel-файлов (DotAero),
- XML (PointzAggregator).

**Особенности:**
- Автоматическое восстановление имён из `FullName`.
- Объединение дубликатов по документу (`TravelDoc`).
- Логирование расхождений в `suspicious_docs.log`.

Результат:  
 `data/processed/merged_passengers.csv`

---

### **Этап 2. Присоединение рейсов**
`merge_csv.attach_flights()`  
Добавляет к пассажирам таблицу рейсов:
- CSV (`trial_flights.csv`, из PDF);
- JSON (`FrequentFlyerForum-Profiles.json`);
- YAML (`SkyTeam-Exchange.yaml`).

**Проводится:**
- нормализация дат и кодов,
- выравнивание схемы,
- объединение по `FlightNumber + DepartDate`.

Результат:  
 `data/processed/merged_passengers_flights.csv`

---

### **Этап 3. Очистка и финализация**
`merge_csv.clean_columns()`  
Удаляет префиксы источников (`flights_`, `sirena_`, `xml_`, и т. д.),  
сливает дубликаты колонок, приводит к единому виду.

Результат:  
 `data/processed/merged_all_sources.csv`

---


##  Зависимости проекта

Проект реализован на **Python**  
и использует набор библиотек для работы с табличными, XML, JSON, YAML и PDF-данными,  
а также для логирования и параллельной обработки.

###  Основные зависимости
| Библиотека | Назначение |
|-------------|-------------|
| `pandas` | Базовый фреймворк для загрузки, объединения и нормализации таблиц (CSV, Excel, JSON, XML). |
| `openpyxl` | Поддержка чтения и записи `.xlsx` файлов (используется в модулях `excel_reader.py` и `sirena_reader.py`). |
| `PyYAML` | Чтение YAML-файлов расписаний (`SkyTeam-Exchange.yaml`). |
| `PyPDF2` | Извлечение текста из PDF-файлов расписаний (`Skyteam_Timetable.pdf`). |
| `concurrent.futures` *(встроенная)* | Параллельная обработка Excel-файлов в `read_excel_dir()` для ускорения работы. |
| `logging` *(встроенная)* | Подробное логирование каждого этапа конвейера. |
| `re`, `datetime`, `pathlib`, `time` *(встроенные)* | Регулярные выражения, обработка путей, дат и контроль времени выполнения. |

---

###  Дополнительные (опциональные) зависимости
| Библиотека | Назначение |
|-------------|-------------|
| `pypdf` | Альтернативный движок для чтения PDF (используется при отсутствии PyPDF2). |
| `camelot-py` | Возможность табличного парсинга PDF (если требуется более точное извлечение таблиц). |
| `unidecode` | Альтернатива встроенной транслитерации (`name_utils.py`). |
| `tqdm` | Прогресс-бар при длительных парсингах (по желанию). |

---

###  Установка зависимостей
Для быстрой установки всех библиотек:
```bash
pip install pandas openpyxl PyYAML PyPDF2


---

##  Пример запуска полного конвейера
```bash
python src/merge_csv.py
```
Результат работы логируется построчно:
```
Этап 1: объединение всех пассажирских источников...
Этап 2: присоединение рейсов (включая JSON и YAML)...
Этап 3: очистка и выравнивание колонок...
Полный конвейер завершён!
```

---

##  Ключевые особенности
- **Параллельная обработка** Excel-файлов (`ProcessPoolExecutor`).
- **Безопасная работа с датами/временем** — пустые значения не вызывают ошибок.
- **Автоматическая транслитерация имён** (рус ↔ лат).
- **Дедупликация пассажиров** с сохранением всех рейсов.
- **Полный автоматический парсинг PDF** с помощью `parse_pdf_tables.py`.
- **Журнал подозрительных расхождений** (`suspicious_docs.log`).

---

##  Итоговая структура данных
| Колонка | Описание |
|----------|-----------|
| FirstName | Имя пассажира |
| SecondName | Отчество |
| LastName | Фамилия |
| PassengerSex | Пол |
| PassengerBirthDate | Дата рождения |
| TravelDoc | Документ |
| TicketNumber | Номер билета |
| DepartDate / DepartTime | Вылет |
| ArrivalDate / ArrivalTime | Прибытие |
| FlightNumber | Номер рейса |
| Airline | Авиакомпания |
| DepartCity / ArrivalCity | Города |
| DepartCode / ArrivalCode | Коды аэропортов |
| Fare / TrvCls | Тариф, класс |
| BonusProgramm | Программа лояльности |
| AgentInfo | Агент / источник |

---

##  Отладка и обработка ошибок

Во время тестирования основного конвейера на этапе `build_passenger_block()`  
возникла ситуация, когда два источника — **Sirena** и **Excel-файлы DotAero** —  
вернули **пустые DataFrame** (возможная причина — несоответствие форматов или отсутствующие столбцы).

При этом остальные источники:
- **Boarding CSV** (данные посадочных талонов),
- **XML PointzAggregator**,
- **YAML SkyTeam**  
успешно отработали и передали корректные данные в конвейер.

Благодаря этому модуль `merge_duplicate_passengers()` из [`name_utils.py`](src/name_utils.py)  
сработал корректно и **обнаружил аномального пассажира** — условного “шпиона”,  
данные которого расходились между источниками.  

Фрагмент диагностического лога `suspicious_docs.log`:

8248 013778;GORDEI, GORDEY, RAMIL;BUROV, GLEBOV;6;SU1057, SU1273, SU1276, SU1281;01.03.2017, 16.01.2017, 2017-01-03, 2017-01-16, 2017-03-09, 2017-03-10;;

Этот “шпион” был обнаружен благодаря механизму сравнения по `TravelDoc`  
и анализу эквивалентности имён в функции `merge_duplicate_passengers()`.  
Алгоритм сравнил строки из разных источников и зафиксировал несовпадения имён и рейсов  
(`GORDEI, GORDEY, RAMIL` ↔ `BUROV, GLEBOV`) в отдельный лог-файл для последующего анализа.

---

###  Механизм обнаружения
1. При чтении источников система зарегистрировала, что два DataFrame (Sirena, Excel) пусты:
 sirena пуст.
 excel пуст.
2. Остальные источники (CSV, XML, YAML) успешно отработали,  
и функция `merge_duplicate_passengers()` была всё равно вызвана.
3. В процессе объединения по `TravelDoc` и анализа имён были выявлены расхождения —  
один и тот же документ встречался с разными наборами имён и рейсов.
4. Эти записи были автоматически записаны в файл `suspicious_docs.log`  
для ручной проверки и последующего исправления источников данных.

---